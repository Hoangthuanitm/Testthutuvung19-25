<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lịch sử kiểm tra - Từ vựng 19-25</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans JP', 'Roboto', sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background-color: #F5F7FA;
            color: #333;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background:#FFFFFF;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        .header h1 {
            margin: 0;
            color: #4A90E2;
            font-size: 1.9em;
        }
        .search-section {
            margin-bottom: 25px;
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: center;
        }
        .search-section label {
            font-weight: 500;
            color: #4A90E2;
            white-space: nowrap;
        }
        .search-section input {
            flex: 1;
            min-width: 250px;
            padding: 10px 12px;
            border: 1px solid #D1D5DB;
            border-radius: 8px;
            font-size: 16px;
        }
        .search-section input:focus {
            outline: none;
            border-color: #4A90E2;
            box-shadow: 0 0 0 3px rgba(74,144,226,0.2);
        }
        .table-container {
            overflow-x: auto;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        table {
            width: 100%;
            border-collapse: collapse;
            background: #FFFFFF;
        }
        th, td {
            padding: 12px 10px;
            text-align: center;
            border: 1px solid #E0E4EA;
            font-size: 0.95em;
        }
        th {
            background: #4A90E2;
            color: #FFFFFF;
            font-weight: 500;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        tr:nth-child(even) { background-color: #F9FAFB; }
        tr:hover { background-color: #EEF2FF; }
        .rank-a { color: #4A90E2; font-weight: bold; }
        .rank-f { color: #EF4444; font-weight: bold; }
        .delete-btn {
            background: #EF4444;
            color: #FFF;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
        }
        .delete-btn:hover { background: #DC2626; }
        .message {
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            text-align: center;
            font-weight: 500;
        }
        .error { background: #FEE2E2; color: #991B1B; border: 1px solid #FECACA; }
        .success { background: #DCFCE7; color: #166534; border: 1px solid #BBF7D0; }
        footer {
            text-align: center;
            margin-top: 50px;
            padding-top: 20px;
            border-top: 1px solid #E0E4EA;
            color: #6B7280;
            font-size: 0.9em;
        }
        @media (max-width: 768px) {
            th, td { padding: 8px 6px; font-size: 0.85em; }
            .search-section input { min-width: 200px; }
        }
    </style>
</head>
<body>

    <div class="header">
        <h1>Lịch sử kiểm tra - Từ vựng 19-25課</h1>
    </div>

    <div class="search-section">
        <label for="search">Tìm kiếm:</label>
        <input type="text" id="search" placeholder="Nhập tên, lớp hoặc ngày (ví dụ: 2025-03-15)">
    </div>

    <div id="message"></div>

    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Thời gian bắt đầu</th>
                    <th>Thời gian kết thúc</th>
                    <th>Ngày</th>
                    <th>Họ tên</th>
                    <th>Lớp</th>
                    <th>問題Ⅰ<br></th>
                    <th>問題Ⅱ<br></th>
                    <th>問題Ⅲ<br></th>
                    <th>問題Ⅳ<br></th>
                    <th>Tổng điểm</th>
                    <th>Tỷ lệ</th>
                    <th>Xếp loại</th>
                    <th>Thao tác</th>
                </tr>
            </thead>
            <tbody id="table-body">
                <tr><td colspan="13">Đang tải dữ liệu...</td></tr>
            </tbody>
        </table>
    </div>

    <footer>
        <p>© 2025 Tài liệu kiểm tra | Thiết kế bởi Thuận</p>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, deleteDoc, doc, query, orderBy } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAfy4QMD9_7PyFHpInNdKDRWuW4AYCtLJ4",
            authDomain: "history-e4633.firebaseapp.com",
            projectId: "history-e4633",
            storageBucket: "history-e4633.firebasestorage.app",
            messagingSenderId: "331974436893",
            appId: "1:331974436893:web:10c3c6adf7b66d2b5fbef4",
            measurementId: "G-DC055090BW"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const maxPoints = { 1: 20, 2: 20, 3: 40, 4: 20 };

        function getRank(p) {
            if (p >= 80) return { text: 'A', cls: 'rank-a' };
            if (p >= 60) return { text: 'B', cls: '' };
            if (p >= 40) return { text: 'C', cls: '' };
            if (p >= 20) return { text: 'D', cls: '' };
            return { text: 'F', cls: 'rank-f' };
        }

        async function loadHistory(search = '') {
            const tbody = document.getElementById('table-body');
            const msg = document.getElementById('message');
            msg.innerHTML = '';
            tbody.innerHTML = '<tr><td colspan="13">Đang tải...</td></tr>';

            try {
const q = query(collection(db, "testHistorytuvung19-25"), orderBy("submittedAt", "desc"));
const snapshot = await getDocs(q);

                let rows = '';
                const term = search.trim().toLowerCase();

                snapshot.forEach(doc => {
                    const d = doc.data();

                    // Lọc tìm kiếm
                    if (term && !(`${d.name} ${d.class} ${d.date}`.toLowerCase().includes(term))) return;

                    const rank = getRank(d.percentage || 0);

                    rows += `
                        <tr>
                            <td>${d.startTime || '-'}</td>
                            <td>${d.endTime || '-'}</td>
                            <td>${d.date || '-'}</td>
                            <td>${d.name || '-'}</td>
                            <td>${d.class || '-'}</td>
                            <td>${d.section1Score || 0}/${maxPoints[1]}</td>
                            <td>${d.section2Score || 0}/${maxPoints[2]}</td>
                            <td>${d.section3Score || 0}/${maxPoints[3]}</td>
                            <td>${d.section4Score || 0}/${maxPoints[4]}</td>
                            <td>${d.totalScore || 0}/100</td>
                            <td>${Math.round(d.percentage || 0)}%</td>
                            <td class="${rank.cls}">${rank.text}</td>
                            <td><button class="delete-btn" data-id="${doc.id}">Xóa</button></td>
                        </tr>`;
                });

                tbody.innerHTML = rows || '<tr><td colspan="13">Không có dữ liệu nào.</td></tr>';
            } catch (e) {
                console.error(e);
                msg.innerHTML = `<div class="message error">Lỗi tải dữ liệu: ${e.message}</div>`;
                tbody.innerHTML = '<tr><td colspan="13">Không thể tải dữ liệu</td></tr>';
            }
        }

        // Xóa bản ghi
        document.getElementById('table-body').addEventListener('click', async e => {
            if (e.target.classList.contains('delete-btn')) {
                if (confirm('Bạn chắc chắn muốn xóa kết quả này?')) {
                    const id = e.target.dataset.id;
                    try {
                        await deleteDoc(doc(db, "testHistorytuvung19-25", id));
                        document.getElementById('message').innerHTML = '<div class="message success">Đã xóa thành công!</div>';
                        loadHistory(document.getElementById('search').value);
                    } catch (err) {
                        document.getElementById('message').innerHTML = `<div class="message error">Xóa thất bại: ${err.message}</div>`;
                    }
                }
            }
        });

        // Tìm kiếm
        document.getElementById('search').addEventListener('input', e => {
            loadHistory(e.target.value);
        });

        // Load lần đầu
        loadHistory();
    </script>
</body>
</html>
